expeditor:
  defaults:
    buildkite:
      timeout_in_minutes: 30

steps:

#######################################################################
# Unit Tests - Linux!
#######################################################################

  - label: "[unit] :linux: butterfly"
    command:
      - ./test/run_cargo_test.sh --nightly --features "deadlock_detection" --test-options "--test-threads=1 six_members_meshed_partition_one_node_from_another_node_remains_alive" butterfly
    agents:
      queue: 'default-privileged'
    plugins:
      docker#v3.0.1:
        always-pull: true
        user: "buildkite-agent"
        group: "buildkite-agent"
        image: "chefes/buildkite"
    timeout_in_minutes: 10
    retry:
      automatic:
        limit: 1

  - label: "[unit] :windows: butterfly"
    command:
      - ./test/run_cargo_test.ps1 butterfly -toolchain "nightly" -Features "deadlock_detection" -TestOptions "--test-threads=1 six_members_meshed_partition_one_node_from_another_node_remains_alive"
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 12 # the butterfly tests usually pass in ~10m
    retry:
      automatic:
        limit: 1
